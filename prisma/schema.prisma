// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum TransactionType {
  SAVINGS
  LOAN
  INTEREST
  MISCELLANEOUS
}

enum InterestMethod {
  SIMPLE      // Flat 1% per week on original principal
  DECLINING   // 1% per week on remaining balance (recommended)
}

enum LoanStatus {
  PENDING     // Loan approved but not disbursed
  ACTIVE      // Loan disbursed and being repaid
  COMPLETED   // Fully repaid
  DEFAULTED   // Defaulted on payments
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  email         String    @unique
  name          String?
  phone         String?
  userId        String?   @unique // User ID for login
  role          UserRole  @default(USER)
  password      String?   // Hashed password for admin
  otp           String?
  otpExpires    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("users")
}

model Member {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  userId        String    @unique // User ID for member
  name          String
  fatherName    String?
  address1      String?
  address2      String?
  accountNumber String?   @unique
  phone         String?
  photo         String?   // URL to photo
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  savings       Savings[]
  loans         Loan[]
  transactions  Transaction[]
  loanSequences LoanSequence[]
  guaranteedLoans1 Loan[] @relation("LoanGuarantor1")
  guaranteedLoans2 Loan[] @relation("LoanGuarantor2")

  @@map("members")
}

model Savings {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  memberId      String    @db.ObjectId
  member        Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  totalAmount   Float     @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  transactions  SavingsTransaction[]

  @@map("savings")
}

model SavingsTransaction {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  savingsId     String    @db.ObjectId
  savings       Savings   @relation(fields: [savingsId], references: [id], onDelete: Cascade)
  date          DateTime
  amount        Float
  total         Float     // Running total after this transaction
  createdAt     DateTime  @default(now())

  @@map("savings_transactions")
}

model LoanCycle {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  cycleNumber   Int       @unique // Cycle number (1, 2, 3...)
  startDate     DateTime
  endDate       DateTime?
  totalMembers  Int       @default(10)
  weeklyAmount  Float     @default(100) // â‚¹100 per member per week
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  loans         Loan[]
  sequences     LoanSequence[]
  groupFund     GroupFund?

  @@map("loan_cycles")
}

model LoanSequence {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  cycleId       String    @db.ObjectId
  cycle         LoanCycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  memberId      String    @db.ObjectId
  member        Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  week          Int       // Week number in cycle (1-10)
  loanAmount    Float     // Amount received this week
  status        String    @default("PENDING") // PENDING, DISBURSED, COMPLETED
  disbursedAt   DateTime?
  loan          Loan?     @relation("LoanSequenceLoan") // Reference to actual loan if created
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([cycleId, week])
  @@map("loan_sequences")
}

model Loan {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  memberId      String    @db.ObjectId
  member        Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  cycleId       String?   @db.ObjectId
  cycle         LoanCycle? @relation(fields: [cycleId], references: [id], onDelete: SetNull)
  sequenceId    String?   @unique @db.ObjectId
  sequence      LoanSequence? @relation("LoanSequenceLoan", fields: [sequenceId], references: [id], onDelete: SetNull)
  principal     Float     // Original loan amount
  remaining     Float     // Remaining balance
  interestRate  Float     @default(1.0) // 1% per week
  interestMethod InterestMethod @default(DECLINING) // Simple or Declining balance
  weeks         Int       @default(10) // 10 weeks repayment
  currentWeek   Int       @default(0)
  status        LoanStatus @default(PENDING)
  totalInterest Float     @default(0) // Total interest paid
  totalPrincipalPaid Float @default(0) // Total principal paid
  disbursedAt   DateTime? // When loan was disbursed
  completedAt   DateTime? // When loan was fully repaid
  guarantor1Id  String?   @db.ObjectId
  guarantor1    Member?   @relation("LoanGuarantor1", fields: [guarantor1Id], references: [id])
  guarantor2Id  String?   @db.ObjectId
  guarantor2    Member?   @relation("LoanGuarantor2", fields: [guarantor2Id], references: [id])
  latePaymentPenalty Float @default(0) // Additional 0.5% per week delayed
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  transactions  LoanTransaction[]

  @@map("loans")
}

model LoanTransaction {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  loanId        String    @db.ObjectId
  loan          Loan      @relation(fields: [loanId], references: [id], onDelete: Cascade)
  date          DateTime
  amount        Float     // Principal payment
  interest      Float     // Interest payment (1% of remaining)
  remaining     Float     // Remaining balance after this payment
  week          Int       // Week number (1-10)
  createdAt     DateTime  @default(now())

  @@map("loan_transactions")
}

model Transaction {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  memberId      String          @db.ObjectId
  member        Member          @relation(fields: [memberId], references: [id], onDelete: Cascade)
  type          TransactionType
  date          DateTime
  purpose       String?
  amount        Float
  photo         String?         // URL to uploaded photo
  createdAt     DateTime        @default(now())

  @@map("transactions")
}

model Event {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  date          DateTime
  name          String
  description   String?
  photos        String[]  // Array of photo URLs
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("events")
}

model MonthlyStatement {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  month         Int       // 1-12
  year          Int
  pdfUrl        String?   // URL to PDF file
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([month, year], name: "month_year")
  @@map("monthly_statements")
}

model GroupFund {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  cycleId       String?   @unique @db.ObjectId
  cycle         LoanCycle? @relation(fields: [cycleId], references: [id], onDelete: SetNull)
  investmentPool Float    @default(0) // Accumulated weekly contributions
  interestPool  Float     @default(0) // Collected interest payments
  emergencyReserve Float  @default(0) // 10% of interest pool
  insuranceFund Float     @default(0) // 5% of each loan for default protection
  adminFee      Float     @default(0) // 0.5% for record-keeping
  totalFunds    Float     @default(0) // Total available funds
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("group_funds")
}

